---
id: 0002
title: Upgrade to Phase II Full-Stack Architecture
stage: constitution
date: 2025-12-09
surface: agent
model: claude-sonnet-4-5-20250929
feature: none
branch: none
user: Msaleemakhtar
command: /sp.constitution
labels: ["constitution", "phase-ii", "full-stack", "architecture", "jwt-auth", "multi-user"]
links:
  spec: null
  ticket: null
  adr: null
  pr: null
files:
  - .specify/memory/constitution.md
tests:
  - None (constitution document)
---

## Prompt

Use @agent-constitution-writer to create the constitution for phase-II following the instructions

### **1. Mission Statement**

To evolve the foundational command-line application into a feature-rich, multi-user, full-stack web application with persistent storage. This phase establishes a scalable, secure, and modern architecture for a cloud-native, distributed system, while strictly adhering to the principles of Spec-Driven Development.

---
### **2. Core Architectural Principles**

#### **I. Spec-Driven Development (Mandatory)**
- **Philosophy**: The specification is the single source of truth.
- **Requirements**: All frontend and backend code **MUST** be generated by an AI agent from written specifications located in the `/specs` directory. Manual coding is forbidden, with documented exceptions for AI limitations.

#### **II. Full-Stack Monorepo Architecture**
- **Philosophy**: A decoupled client-server architecture enables independent development and scaling.
- **Requirements**:
    - The project **MUST** be a monorepo with distinct `frontend` and `backend` directories.
    - A `packages/` directory **MUST** exist at the root to house shared code (e.g., common types, SDKs) used by multiple services.
    - **Frontend**: A responsive web application built with **Next.js (App Router)** and TypeScript. The UI **MUST** be built using **shadcn/ui** components.
    - **Backend**: A RESTful API server built with **Python and FastAPI**.
    - **Package Management**: **`bun`** for the frontend; **`uv`** for the backend. `bun` **MUST** be used as the workspace manager for the entire monorepo.

#### **III. Persistent & Relational State**
- **Philosophy**: Data must be durable, secure, and relationally structured.
- **Requirements**:
    - Application state **MUST** be stored persistently in a **Neon Serverless PostgreSQL** database.
    - Data access **MUST** be managed through **SQLModel**.
    - Database interactions **MUST** be asynchronous, using the **`asyncpg`** driver.
    - Database schema changes **MUST** be managed via **Alembic** migrations.

#### **IV. User Authentication & JWT Security (The JWT Challenge)**
- **Philosophy**: Access must be verified and enforced; every user owns their data.
- **Requirements**:
    1.  **Authentication Provider**: User authentication (signup/signin) **MUST** be handled by **Better Auth** on the Next.js frontend.
    2.  **Token Issuance**: The backend **MUST** issue short-lived, stateless JWT access tokens (e.g., 15-minute expiration) and long-lived refresh tokens (e.g., 7-day expiration).
    3.  **Frontend API Client**: The frontend **MUST** use **`axios`**. An `axios` interceptor **MUST** be implemented to automatically attach the access token to the `Authorization: Bearer <token>` header of every API request.
    4.  **Token Refresh**: Upon receiving a 401 Unauthorized response, the `axios` interceptor **MUST** attempt to use the refresh token to silently obtain a new access token from a dedicated `/auth/refresh` endpoint and then retry the original request.
    5.  **Backend Token Validation**: All backend endpoints (except public auth endpoints, e.g., `/auth/token` and `/auth/refresh`) **MUST** be protected. A FastAPI dependency **MUST** be implemented to decode and validate the access token from the header on every incoming request.
    6.  **Data Isolation**: The authenticated user's ID, extracted from the validated JWT payload, **MUST** be used to scope all database queries, ensuring strict data isolation.
    7.  **Secure Token Storage**: Refresh tokens **MUST** be stored securely in an `HttpOnly` cookie. Access tokens may be stored in memory.

---
### **3. Implementation & Best Practices**

#### **I. Backend Architecture & Best practices**
- **Structure**: Endpoints **MUST** be organized into logical modules within a `routers/` directory using FastAPI's `APIRouter`. API routes **MUST** be prefixed with a version number (e.g., `/api/v1`).
- **Configuration**: All configuration (database URLs, secrets) **MUST** be managed via `pydantic-settings`, loading from environment variables or `.env` files.
- **API Documentation**: FastAPI's automatic OpenAPI documentation (Swagger UI/ReDoc) **MUST** be enabled, and all endpoints and models **MUST** include clear descriptions.
- **Security**:
    - A strict Cross-Origin Resource Sharing (CORS) policy **MUST** be implemented to allow requests only from the deployed frontend's domain.
    - `Pydantic` models **MUST** be used for strict input validation on all incoming request bodies.
- **Testing**: Tests **MUST** use `pytest`. Where appropriate, use `testcontainers` or a similar library to create isolated databases for integration tests.
- **Code Quality & Security Automation**: The project **MUST** use `pre-commit` hooks to automatically run linters (`ruff check`), formatters (`ruff format`), and dependency vulnerability scanners (`pip-audit`) on every commit.

#### **II. Frontend Architecture & User Experience**
- **Component Structure**: The frontend **MUST** follow a clear component structure, such as organizing components by feature (e.g., `features/tasks/components/`) or by type (e.g., `components/ui`, `components/common`).
- **State Management**: Global client-side state (e.g., auth status, user info) **MUST** be managed by **Zustand**.
- **Environment Variables**: Frontend environment variables intended for browser exposure **MUST** be prefixed with `NEXT_PUBLIC_`.
- **User Experience Mandates**: The frontend **MUST** implement:
    - **Optimistic UI Updates** for common actions (add, delete, complete task).
    - **Skeleton Loading States** while data is being fetched.
    - **Non-Blocking Toast Notifications** for user feedback (success/error).
    - **Input Debouncing** for search functionality.

#### **III. Containerization & Deployment**
- **Philosophy**: Services must be packaged for consistency and portability across environments.
- **Requirements**:
    - A `Dockerfile` **MUST** be created for both the `frontend` and `backend` services.
    - A `docker-compose.yml` file **SHOULD** be used to orchestrate the local development environment (frontend, backend, database).

#### **IV. Continuous Integration / Continuous Deployment (CI/CD)**
- **Continuous Integration**: A CI pipeline (e.g., using GitHub Actions) **MUST** be implemented. All pull requests **MUST** pass all checks before being eligible for merging. These checks **MUST** include:
    - Linting and static analysis for both frontend and backend.
    - All automated tests (unit, integration).
    - Successful build of both services.
- **Continuous Deployment**: Merges to the `main` branch **SHOULD** automatically deploy the application to a staging environment. Tagged releases **MUST** automatically deploy to the production environment.

---
### **4. Feature Scope (Phase II)**

This phase includes the implementation of all Basic, Intermediate, and Advanced features.

- **Basic**: Add Task, Delete Task, Update Task, View Task List, Mark as Complete.
- **Intermediate**:
    - **Priorities & Tags/Categories**: Assign priority levels and custom tags.
    - **Search & Filter**: Keyword search; filter by status, priority, or tag.
    - **Sort Tasks**: Order by due date, priority, or creation date.
- **Advanced**:
    - **Due Dates & Time Reminders**: Set deadlines and get browser notifications.
    - **Recurring Tasks**: Define recurrence rules (e.g., weekly) for tasks.

---
### **5. Data Model Specification (SQLModel)**

| Model | Field | Type | Rules |
| :--- | :--- | :--- | :--- |
| **User**| `id` | `str` | Primary Key, from Better Auth |
| | `email` | `str` | Unique |
| **Tag** | `id` | `int` | Primary Key |
| | `name` | `str` | Not Null |
| | `user_id`| `str` | Foreign Key -> `User.id` |
| **Task** | `id` | `int` | Primary Key |
| | `title` | `str` | Not Null, 1-200 chars |
| | `description` | `Optional[str]` | Max 1000 chars |
| | `completed` | `bool` | Default: `False` |
| | `priority` | `str`| Enum: 'low', 'medium', 'high', Default: 'medium' |
| | `due_date`| `Optional[datetime]`| |
| |`recurrence_rule`|`Optional[str]`| iCal RRULE string |
| | `user_id` | `str` | Foreign Key -> `User.id` |
| | `created_at`| `datetime`| Auto-generated. Use `default_factory=datetime.utcnow` |
| | `updated_at`| `datetime`| Auto-updated on modification. Use `sa_column_kwargs={"onupdate": datetime.utcnow}` |
| | `tags`| `List[Tag]`| Many-to-Many via `TaskTagLink` |
|**TaskTagLink**|`task_id` |`int`| Foreign Key -> `Task.id` |
| |`tag_id` | `int` | Foreign Key -> `Tag.id` |

## Response snapshot

Successfully created Phase II constitution (v2.0.0) representing a major architectural transformation from CLI-only (v1.0.0) to full-stack web application with multi-user authentication and persistent storage. The constitution includes 10 core principles covering Spec-Driven Development, Full-Stack Monorepo Architecture, Persistent State (Neon PostgreSQL), JWT Authentication Challenge, Backend/Frontend Standards, Testing, Containerization, CI/CD, and Feature Scope. A complete data model with 4 entities (User, Tag, Task, TaskTagLink) was defined with 20 requirements mapped to constitutional rules. All 4 constitutional self-checks passed.

## Outcome

- ‚úÖ Impact: Constitution upgraded from v1.0.0 to v2.0.0 with complete Phase II governance framework. Replaced 4 of 7 Phase I principles, added 3 new principles (VIII, IX, X), and expanded data model for multi-user support.
- üß™ Tests: None (constitutional document; validation via 4 self-checks: alignment, coverage, conflict, completeness)
- üìÅ Files: Modified `.specify/memory/constitution.md` with Sync Impact Report prepended as HTML comment
- üîÅ Next prompts: Update `/specs/database/schema.md` with Tag and TaskTagLink tables; Update `/specs/api/rest-endpoints.md` with /auth and /tags endpoints; Document full-stack architecture in `/specs/architecture.md`
- üß† Reflection: Major version bump (1.x ‚Üí 2.0.0) correctly reflects breaking architectural changes. The JWT authentication flow is complex but well-specified with 7 numbered requirements ensuring end-to-end security.

## Evaluation notes (flywheel)

- Failure modes observed: PHR was NOT automatically created by the constitution-writer agent after completing the constitution update, despite clear instructions in the /sp.constitution command (lines 82-104). This required manual PHR creation after the fact.
- Graders run and results (PASS/FAIL): Constitutional self-checks: Alignment ‚úÖ PASS, Coverage ‚úÖ PASS, Conflict-Free ‚úÖ PASS, Completeness ‚úÖ PASS
- Prompt variant (if applicable): none
- Next experiment (smallest change to try): Ensure constitution-writer agent explicitly executes PHR creation step as final action, with error handling and validation reporting. Consider adding a post-completion hook to verify PHR exists before agent returns.
