# Data Model: Fix ChatKit Integration and Better-Auth Backend

**Generated**: 2025-12-20
**Phase**: Phase 1 - Design
**Status**: Complete

## Purpose

Document the Better Auth database schema and its relationships with existing Phase III entities. This data model defines the four Better Auth tables required for multi-user authentication.

---

## Entity Relationship Overview

```
┌─────────────────┐
│      user       │  ← Better Auth core entity
│  (Better Auth) │
│                 │
│  - id: TEXT PK  │
│  - email        │
│  - emailVerified│
│  - name         │
│  - image        │
└────────┬────────┘
         │
         │ 1:N
         │
    ┌────┴─────────────────────────────────┐
    │                                       │
    ▼                                       ▼
┌──────────────────┐                ┌─────────────────┐
│     session      │                │    account      │
│  (Better Auth)   │                │ (Better Auth)   │
│                  │                │                 │
│  - id: TEXT PK   │                │  - id: TEXT PK  │
│  - userId: FK    │                │  - userId: FK   │
│  - token         │                │  - providerId   │
│  - expiresAt     │                │  - password     │
└──────────────────┘                └─────────────────┘

┌──────────────────┐
│  verification    │
│  (Better Auth)   │
│                  │
│  - id: TEXT PK   │
│  - identifier    │
│  - value         │
│  - expiresAt     │
└──────────────────┘

Existing Phase III Entities (Reference Only - Not Modified):

┌─────────────────────┐       ┌──────────────────┐
│  tasks_phaseiii     │       │  conversations   │
│                     │       │                  │
│  - id: INTEGER PK   │       │  - id: INT PK    │
│  - user_id: TEXT    │───┐   │  - user_id: TEXT │
│  - title            │   │   │  - external_id   │
│  - description      │   │   └────────┬─────────┘
│  - completed        │   │            │
└─────────────────────┘   │            │ 1:N
                          │            │
                          │            ▼
                          │   ┌──────────────────┐
                          │   │    messages      │
                          │   │                  │
                          └──▶│  - user_id: TEXT │
                              │  - conversation_id│
                              │  - role          │
                              │  - content       │
                              └──────────────────┘

Note: user_id in Phase III entities references user.id from Better Auth
```

---

## Better Auth Entities

### 1. user (Better Auth Core Entity)

**Purpose**: Store user account information for authentication and identification.

**Table Name**: `user` (lowercase, singular - Better Auth convention)

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | TEXT | PRIMARY KEY | Unique user identifier (UUID format) |
| email | TEXT | UNIQUE, NOT NULL | User's email address |
| emailVerified | BOOLEAN | NOT NULL, DEFAULT FALSE | Email verification status |
| name | TEXT | NULLABLE | User's display name |
| image | TEXT | NULLABLE | User's profile image URL |
| createdAt | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | Account creation timestamp |
| updatedAt | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | Last update timestamp |

**Validation Rules**:
- `email`: Must be valid email format, unique across all users
- `id`: Generated by Better Auth (UUID v4)
- `emailVerified`: Set to TRUE after email verification (out of scope for MVP, remains FALSE)

**Indexes**:
- `idx_user_email` on `email` (UNIQUE) - Fast email lookup for login

**Relationships**:
- One-to-Many with `session` (one user can have multiple active sessions)
- One-to-Many with `account` (one user can have multiple auth providers, but only email/password for MVP)

---

### 2. session (Better Auth Session Management)

**Purpose**: Store active authentication sessions with JWT tokens and metadata.

**Table Name**: `session` (lowercase, singular - Better Auth convention)

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | TEXT | PRIMARY KEY | Unique session identifier |
| userId | TEXT | NOT NULL, FOREIGN KEY → user.id ON DELETE CASCADE | Owner of the session |
| expiresAt | TIMESTAMP | NOT NULL | Session expiration time |
| token | TEXT | UNIQUE, NOT NULL | Session token (used internally by Better Auth) |
| ipAddress | TEXT | NULLABLE | Client IP address |
| userAgent | TEXT | NULLABLE | Client user agent string |
| createdAt | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | Session creation time |
| updatedAt | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | Last activity timestamp |

**Validation Rules**:
- `expiresAt`: Must be in the future when created
- `token`: Generated by Better Auth (cryptographically secure random)
- `userId`: Must reference existing user.id

**Indexes**:
- `idx_session_userId` on `userId` - Fast user session lookup
- `idx_session_token` on `token` (UNIQUE) - Fast token validation

**Relationships**:
- Many-to-One with `user` (CASCADE DELETE - when user deleted, all sessions deleted)

**Note**: This table stores Better Auth's internal session tokens. JWT tokens (for API authentication) are generated separately via the JWT plugin and included in the session object but not stored in this table.

---

### 3. account (Authentication Provider Information)

**Purpose**: Store authentication method details (email/password for MVP).

**Table Name**: `account` (lowercase, singular - Better Auth convention)

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | TEXT | PRIMARY KEY | Unique account identifier |
| userId | TEXT | NOT NULL, FOREIGN KEY → user.id ON DELETE CASCADE | Owner of the account |
| accountId | TEXT | NOT NULL | Provider-specific account ID (email for email provider) |
| providerId | TEXT | NOT NULL | Provider identifier ("credential" for email/password) |
| password | TEXT | NULLABLE | Hashed password (only for email/password auth) |
| accessToken | TEXT | NULLABLE | OAuth access token (unused in MVP) |
| refreshToken | TEXT | NULLABLE | OAuth refresh token (unused in MVP) |
| expiresAt | TIMESTAMP | NULLABLE | Token expiration (unused in MVP) |
| createdAt | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | Account link timestamp |
| updatedAt | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | Last update timestamp |

**Validation Rules**:
- `password`: Hashed with bcrypt (Better Auth handles hashing)
- `providerId`: For MVP, always "credential" (email/password provider)
- `accountId`: For email provider, this is the user's email address
- **UNIQUE** constraint on `(providerId, accountId)` - One account per provider per user

**Indexes**:
- `idx_account_userId` on `userId` - Fast user account lookup
- `idx_account_provider` on `(providerId, accountId)` (UNIQUE) - Prevent duplicate provider accounts

**Relationships**:
- Many-to-One with `user` (CASCADE DELETE - when user deleted, all accounts deleted)

**Security Notes**:
- Passwords MUST be hashed (Better Auth uses bcrypt by default)
- Never expose password field in API responses
- Password reset not in scope (users can create new accounts)

---

### 4. verification (Email Verification Tokens)

**Purpose**: Store email verification tokens for confirming user email addresses.

**Table Name**: `verification` (lowercase, singular - Better Auth convention)

**Note**: Email verification is OUT OF SCOPE for this MVP (users are active immediately), but this table is required by Better Auth's schema and may be used in future enhancements.

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | TEXT | PRIMARY KEY | Unique verification identifier |
| identifier | TEXT | NOT NULL | Email address or user ID being verified |
| value | TEXT | NOT NULL | Verification token (secure random) |
| expiresAt | TIMESTAMP | NOT NULL | Token expiration time |
| createdAt | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | Token creation time |
| updatedAt | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | Last update timestamp |

**Validation Rules**:
- `value`: Cryptographically secure random token
- `expiresAt`: Typically 24-48 hours from creation

**Indexes**:
- `idx_verification_identifier` on `identifier` - Fast verification lookup

**Relationships**:
- None (standalone table)

**Usage** (Future Scope):
- User signs up → verification row created with email and token
- Email sent with verification link containing token
- User clicks link → token validated and marked as used
- user.emailVerified set to TRUE

---

## Integration with Existing Phase III Entities

### Relationship: user ↔ tasks_phaseiii

**Type**: One-to-Many (implicit, no foreign key)

**Linkage**: `tasks_phaseiii.user_id` references `user.id` (TEXT)

**Cascade Behavior**: Not enforced at database level (no FK constraint per Phase III design)

**Data Isolation**: All task queries MUST filter by `user_id` from JWT token

**Example Query**:
```sql
-- Get user's tasks
SELECT * FROM tasks_phaseiii
WHERE user_id = :jwt_user_id
ORDER BY created_at DESC;
```

---

### Relationship: user ↔ conversations

**Type**: One-to-Many (implicit, no foreign key)

**Linkage**: `conversations.user_id` references `user.id` (TEXT)

**Cascade Behavior**: Not enforced at database level

**Data Isolation**: All conversation queries MUST filter by `user_id` from JWT token

**Example Query**:
```sql
-- Get user's conversations
SELECT * FROM conversations
WHERE user_id = :jwt_user_id
ORDER BY updated_at DESC;
```

---

### Relationship: user ↔ messages

**Type**: One-to-Many (implicit, no foreign key)

**Linkage**: `messages.user_id` references `user.id` (TEXT)

**Cascade Behavior**: Not enforced at database level

**Data Isolation**: All message queries MUST filter by `user_id` from JWT token

**Example Query**:
```sql
-- Get conversation messages for user
SELECT m.* FROM messages m
WHERE m.conversation_id = :conversation_id
  AND m.user_id = :jwt_user_id
ORDER BY m.created_at ASC;
```

---

## Migration Strategy

### Migration File: 003_better_auth_tables.py

**Action**: CREATE (new tables)

**Reversibility**: Full downgrade support (DROP tables)

**Dependencies**: None (Better Auth tables are independent)

**Migration Order**:
1. Create `user` table (no dependencies)
2. Create `session` table (depends on `user`)
3. Create `account` table (depends on `user`)
4. Create `verification` table (no dependencies)

**Indexes Created**:
- `idx_user_email` (UNIQUE)
- `idx_session_userId`
- `idx_session_token` (UNIQUE)
- `idx_account_userId`
- `idx_account_provider` (UNIQUE)
- `idx_verification_identifier`

---

## Data Access Patterns

### Pattern 1: User Registration

```sql
-- 1. Better Auth creates user
INSERT INTO user (id, email, emailVerified, createdAt, updatedAt)
VALUES ('uuid-here', 'user@example.com', FALSE, NOW(), NOW());

-- 2. Better Auth creates email/password account
INSERT INTO account (id, userId, accountId, providerId, password, createdAt, updatedAt)
VALUES ('account-uuid', 'uuid-here', 'user@example.com', 'credential', '$bcrypt_hash', NOW(), NOW());

-- 3. Session created on login (handled by Better Auth)
```

### Pattern 2: User Login

```sql
-- 1. Better Auth validates credentials
SELECT a.password FROM account a
JOIN user u ON u.id = a.userId
WHERE a.accountId = :email
  AND a.providerId = 'credential';

-- 2. Better Auth creates session
INSERT INTO session (id, userId, token, expiresAt, ipAddress, userAgent, createdAt, updatedAt)
VALUES (...);

-- 3. JWT generated via JWT plugin (in-memory, not stored)
```

### Pattern 3: JWT Token Validation (Backend)

```python
# FastAPI dependency
from jose import jwt

payload = jwt.decode(token, settings.better_auth_secret, algorithms=["HS256"])
user_id = payload.get("sub")  # user.id from Better Auth

# Now use user_id to scope all queries
tasks = await session.exec(
    select(Task).where(Task.user_id == user_id)
)
```

---

## Schema Change Impact

**Tables Added**: 4 (user, session, account, verification)

**Tables Modified**: 0 (existing Phase III tables unchanged)

**Backward Compatibility**: Full (existing data unaffected)

**Breaking Changes**: None

**Rollback Safety**: Full (all changes reversible via migration downgrade)

---

## Next Steps

1. ✅ Data model documented
2. Generate `contracts/auth-types.ts` - TypeScript interfaces matching this schema
3. Generate `quickstart.md` - Setup instructions and environment configuration
4. Update agent context - Add Better Auth JWT plugin to tech stack
