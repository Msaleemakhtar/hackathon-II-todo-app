openapi: 3.0.3
info:
  title: CloudEvents 1.0 Schema
  description: |
    CloudEvents envelope format used by Dapr Pub/Sub.
    This wraps application events with standardized metadata.
  version: 1.0.0
  contact:
    name: CloudEvents Specification
    url: https://github.com/cloudevents/spec/blob/v1.0/spec.md

components:
  schemas:
    CloudEvent:
      type: object
      required:
        - specversion
        - id
        - source
        - type
      properties:
        specversion:
          type: string
          description: CloudEvents specification version
          enum: ["1.0"]
          example: "1.0"
        id:
          type: string
          description: Unique event identifier (UUID generated by Dapr)
          format: uuid
          example: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
        source:
          type: string
          description: Event source (Dapr app-id)
          example: "backend"
        type:
          type: string
          description: Event type (matches application event class name)
          example: "TaskCreatedEvent"
        time:
          type: string
          format: date-time
          description: Event timestamp (ISO 8601)
          example: "2026-01-15T12:00:00Z"
        datacontenttype:
          type: string
          description: Content type of the data field
          default: "application/json"
          example: "application/json"
        data:
          type: object
          description: Application event payload (original event schema)
          additionalProperties: true
          example:
            event_type: "created"
            task_id: 123
            task_data:
              id: 123
              user_id: 1
              title: "Complete Dapr migration"
              priority: "high"
              due_date: "2026-01-20T17:00:00Z"
              completed: false
            user_id: 1
            timestamp: "2026-01-15T12:00:00Z"
        subject:
          type: string
          description: Optional subject (not used by this application)
          example: "task/123"
        dataschema:
          type: string
          format: uri
          description: Optional schema URL (not used by this application)

    CloudEventBatch:
      type: array
      description: Batch of CloudEvents (Dapr supports bulk delivery)
      items:
        $ref: '#/components/schemas/CloudEvent'
      example:
        - specversion: "1.0"
          id: "event-1"
          source: "backend"
          type: "TaskCreatedEvent"
          time: "2026-01-15T12:00:00Z"
          datacontenttype: "application/json"
          data:
            event_type: "created"
            task_id: 123
            user_id: 1
        - specversion: "1.0"
          id: "event-2"
          source: "backend"
          type: "TaskCreatedEvent"
          time: "2026-01-15T12:00:01Z"
          datacontenttype: "application/json"
          data:
            event_type: "created"
            task_id: 124
            user_id: 1

paths:
  /events/{topic}:
    post:
      summary: CloudEvents consumer endpoint
      description: |
        Application endpoints receive CloudEvents from Dapr subscriptions.
        This is the consumer-side contract.
      operationId: receiveCloudEvent
      parameters:
        - name: topic
          in: path
          required: true
          description: Topic name (extracted from subscription route)
          schema:
            type: string
            example: task-reminders
      requestBody:
        required: true
        content:
          application/cloudevents+json:
            schema:
              $ref: '#/components/schemas/CloudEvent'
          application/json:
            schema:
              $ref: '#/components/schemas/CloudEvent'
      responses:
        '200':
          description: Event processed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [SUCCESS, RETRY, DROP]
                    example: SUCCESS
        '400':
          description: Malformed CloudEvent (DROP - do not retry)
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: DROP
        '500':
          description: Processing failed (RETRY - Dapr will requeue)
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: RETRY
                  error:
                    type: string
