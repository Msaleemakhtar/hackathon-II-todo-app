apiVersion: apps/v1
kind: Deployment
metadata:
  name: notification-service
  namespace: {{ include "todo-app.namespace" . }}
  labels:
    {{- include "todo-app.labels" . | nindent 4 }}
    app.kubernetes.io/component: notification-service
spec:
  replicas: 1  # Single replica for MVP to avoid duplicate reminders
  selector:
    matchLabels:
      app: notification-service
  template:
    metadata:
      labels:
        app: notification-service
        {{- include "todo-app.labels" . | nindent 8 }}
      annotations:
        dapr.io/enabled: "{{ .Values.dapr.enabled }}"
        dapr.io/app-id: "notification-service"
        dapr.io/app-port: "8002"
        dapr.io/log-level: "info"
        dapr.io/sidecar-cpu-limit: "{{ .Values.dapr.resources.limits.cpu }}"
        dapr.io/sidecar-memory-limit: "{{ .Values.dapr.resources.limits.memory }}"
        dapr.io/sidecar-cpu-request: "{{ .Values.dapr.resources.requests.cpu }}"
        dapr.io/sidecar-memory-request: "{{ .Values.dapr.resources.requests.memory }}"
    spec:
      serviceAccountName: todo-app-sa
      containers:
      - name: notification-service
        image: "{{ .Values.backend.image.repository }}:{{ .Values.backend.image.tag }}"
        imagePullPolicy: {{ .Values.global.imagePullPolicy }}
        command:
          - "python"
          - "-m"
          - "app.services.notification_service_standalone"
        env:
          # Database connection
          - name: DATABASE_URL
            valueFrom:
              secretKeyRef:
                name: todo-app-secrets
                key: DATABASE_URL
          # Kafka configuration (secrets)
          - name: KAFKA_BOOTSTRAP_SERVERS
            valueFrom:
              secretKeyRef:
                name: todo-app-secrets
                key: KAFKA_BOOTSTRAP_SERVERS
          - name: KAFKA_SASL_USERNAME
            valueFrom:
              secretKeyRef:
                name: todo-app-secrets
                key: KAFKA_SASL_USERNAME
          - name: KAFKA_SASL_PASSWORD
            valueFrom:
              secretKeyRef:
                name: todo-app-secrets
                key: KAFKA_SASL_PASSWORD
          # Kafka configuration (non-sensitive)
          - name: KAFKA_SECURITY_PROTOCOL
            valueFrom:
              configMapKeyRef:
                name: todo-app-config
                key: KAFKA_SECURITY_PROTOCOL
          - name: KAFKA_SASL_MECHANISM
            valueFrom:
              configMapKeyRef:
                name: todo-app-config
                key: KAFKA_SASL_MECHANISM
          # Dapr configuration
          - name: USE_DAPR
            valueFrom:
              configMapKeyRef:
                name: todo-app-config
                key: USE_DAPR
        resources:
          requests:
            cpu: "200m"
            memory: "256Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"
        livenessProbe:
          httpGet:
            path: /health
            port: 8002
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /health
            port: 8002
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
      restartPolicy: Always
---
apiVersion: v1
kind: Service
metadata:
  name: notification-service
  namespace: {{ include "todo-app.namespace" . }}
  labels:
    {{- include "todo-app.labels" . | nindent 4 }}
    app.kubernetes.io/component: notification-service
spec:
  selector:
    app: notification-service
  ports:
    - name: http
      protocol: TCP
      port: 8002
      targetPort: 8002
  type: ClusterIP
