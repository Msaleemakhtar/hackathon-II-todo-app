# Helm Values for Todo App Phase V
# Override these values using --set flag or custom values-local.yaml

# Namespace Configuration
namespace: "todo-phasev"
environment: "production"

# Global Configuration
global:
  namespace: "todo-phasev"  # Constitutional requirement
  imagePullPolicy: "IfNotPresent"  # Avoid pulling if image exists locally

# Frontend Configuration
frontend:
  enabled: true
  replicaCount: 2  # Initial replicas (HPA manages dynamically)
  image:
    repository: "todo-frontend"
    tag: "latest"
    pullPolicy: "IfNotPresent"
  service:
    type: "ClusterIP"
    port: 3000
    targetPort: 3000
  resources:
    requests:
      cpu: "500m"
      memory: "512Mi"
    limits:
      cpu: "1000m"
      memory: "1024Mi"
  livenessProbe:
    httpGet:
      path: "/"
      port: 3000
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  readinessProbe:
    httpGet:
      path: "/"
      port: 3000
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 5
    targetCPUUtilizationPercentage: 70

# Backend Configuration
backend:
  enabled: true
  replicaCount: 2  # Initial replicas (HPA manages dynamically)
  image:
    repository: "todo-app-backend"
    tag: "latest"
    pullPolicy: "IfNotPresent"
  service:
    type: "ClusterIP"
    port: 8000
    targetPort: 8000
  resources:
    requests:
      cpu: "500m"
      memory: "512Mi"
    limits:
      cpu: "1000m"
      memory: "1024Mi"
  livenessProbe:
    httpGet:
      path: "/health"
      port: 8000
    initialDelaySeconds: 30  # Increased to allow database + Kafka initialization
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  readinessProbe:
    httpGet:
      path: "/health"
      port: 8000
    initialDelaySeconds: 45  # Increased to allow Kafka producer initialization (~26s total)
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 5
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80

# MCP Server Configuration
mcpServer:
  enabled: true
  replicaCount: 1  # Fixed single replica
  image:
    repository: "todo-app-backend"  # Reuses backend image
    tag: "latest"
    pullPolicy: "IfNotPresent"
  service:
    type: "ClusterIP"
    port: 8001
    targetPort: 8001
  resources:
    requests:
      cpu: "250m"
      memory: "256Mi"
    limits:
      cpu: "500m"
      memory: "512Mi"
  livenessProbe:
    tcpSocket:
      port: 8001
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  readinessProbe:
    tcpSocket:
      port: 8001
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

# Redis Configuration
redis:
  enabled: true
  image:
    repository: "redis"
    tag: "7-alpine"
    pullPolicy: "IfNotPresent"
  service:
    type: "ClusterIP"
    port: 6379
    targetPort: 6379
  resources:
    requests:
      cpu: "250m"
      memory: "128Mi"
    limits:
      cpu: "500m"
      memory: "256Mi"
  livenessProbe:
    exec:
      command:
        - "redis-cli"
        - "ping"
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  readinessProbe:
    exec:
      command:
        - "redis-cli"
        - "ping"
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  persistence:
    enabled: true
    storageClassName: "standard"
    accessMode: "ReadWriteOnce"
    size: "1Gi"
  command:
    - "redis-server"
    - "--appendonly"
    - "yes"

# Database Configuration
database:
  secretName: "todo-app-secrets"

# Kafka Configuration (Redpanda Cloud)
kafka:
  secretName: "todo-app-secrets"

# Email Delivery Service Configuration
emailDelivery:
  enabled: true
  name: "email-delivery"
  replicaCount: 1  # Single replica to prevent duplicate emails
  image: "todo-email-delivery:latest"
  imagePullPolicy: "Never"  # Use local image from Minikube
  secretName: "email-delivery-secret"
  consumerGroup: "email-delivery-consumer-group-v2"  # Changed to reset offsets and consume from earliest
  logLevel: "INFO"
  smtp:
    host: "smtp.gmail.com"
    port: 587
    fromEmail: "your-email@gmail.com"  # Override via --set
    fromName: "Todo App Reminders"
    username: ""  # Set via --set emailDelivery.smtp.username=your-email@gmail.com
    password: ""  # Set via --set emailDelivery.smtp.password=your-app-password
  resources:
    requests:
      cpu: "100m"
      memory: "128Mi"
    limits:
      cpu: "200m"
      memory: "256Mi"

# Notification Service Configuration
notificationService:
  enabled: true
  name: "notification-service"
  replicaCount: 1  # Single replica to prevent duplicate notifications
  imagePullPolicy: "Never"  # Use local image from Minikube
  consumerGroup: "notification-service-group"
  logLevel: "INFO"
  resources:
    requests:
      cpu: "100m"
      memory: "128Mi"
    limits:
      cpu: "200m"
      memory: "256Mi"

# Recurring Task Service Configuration
recurringTaskService:
  enabled: true
  name: "recurring-task-service"
  replicaCount: 1  # Single replica to prevent duplicate task generation
  imagePullPolicy: "Never"  # Use local image from Minikube
  consumerGroup: "recurring-task-service-group"
  logLevel: "INFO"
  resources:
    requests:
      cpu: "100m"
      memory: "128Mi"
    limits:
      cpu: "200m"
      memory: "256Mi"

# Ingress Configuration
ingress:
  enabled: true
  className: "nginx"
  host: "todo-app.local"
  tls:
    enabled: true  # Enable HTTPS
    # TLS secret (todo-app-tls) should be created separately with cert and key

# Secrets Configuration
# IMPORTANT: DO NOT commit actual secrets to git
# Use values-local.yaml (gitignored) or --set flags for sensitive data
# All values MUST be base64-encoded
# Example: echo -n "postgres://..." | base64
secrets:
  databaseUrl: "cG9zdGdyZXNxbCthc3luY3BnOi8vbmVvbmRiX293bmVyOm5wZ196VGtxMUFCSFI4dUNAZXAtZ3JlZW4tc2hhcGUtYWR2bTA5d28tcG9vbGVyLmMtMi51cy1lYXN0LTEuYXdzLm5lb24udGVjaC9uZW9uZGI/c3NsPQ=="  # Base64-encoded Neon PostgreSQL URL (backend - asyncpg driver)
  frontendDatabaseUrl: "cG9zdGdyZXNxbDovL25lb25kYl9vd25lcjpucGdfelRrcTFBQkhSOHVDQGVwLWdyZWVuLXNoYXBlLWFkdm0wOXdvLXBvb2xlci5jLTIudXMtZWFzdC0xLmF3cy5uZW9uLnRlY2gvbmVvbmRiP3NzbG1vZGU9cmVxdWlyZQ=="  # Base64-encoded Neon PostgreSQL URL (frontend - plain driver)
  openaiApiKey: "c2stcHJvai0wc3VNdGxzcVdzeHBnTEMtUjVZNlg3VTR2QTgwSFFfSExCZWRWTHA4dllEbG9BdWp2UE9pVDE0d25lRzhUcjdwTDNDSEtITkJ4OFQzQmxia0ZKdWJEMl9Odzk4bGhQcERZZ0UxRnlUZWtncWhSZk5ZMEpIWXp3QnJoYkRTck85WWZSR3gxOW5PNHVvQ1g3VFhham9nd1ltdDN0TUE="  # Base64-encoded OpenAI API key
  betterAuthSecret: "OWIzMmExZGYyMWQ2NmQxOGZhN2MwMGNkZWJkMjVkOTRhM2YzYjI3YWQwYzEwOTAxNzU2ODMxNDI0YjY3YjAzMw=="  # Base64-encoded Better Auth shared secret
  betterAuthUrl: "aHR0cHM6Ly90b2RvLWFwcC5sb2NhbA=="  # Base64-encoded Better Auth URL
  redisPassword: ""  # Base64-encoded Redis password (optional)
  kafkaBootstrapServers: "ZDVrOGNmNnVkdTA1bDl2cmtpc2cuYW55LmFwLXNvdXRoLTEubXB4LnByZC5jbG91ZC5yZWRwYW5kYS5jb206OTA5Mg=="  # Base64-encoded Redpanda Cloud bootstrap servers (e.g., "abc123.c.redpanda.cloud:9092")
  kafkaSaslUsername: "c2FsZWVt"  # Base64-encoded Kafka SASL username
  kafkaSaslPassword: "czVmZFVyVTRRMWFaRDU2TFdicjZ0N0xHYkdiWUow"  # Base64-encoded Kafka SASL password

# ConfigMap Configuration (Non-sensitive data)
configMap:
  REDIS_HOST: "redis-service.todo-phasev.svc.cluster.local"
  REDIS_PORT: "6379"
  MCP_SERVER_URL: "http://mcp-service.todo-phasev.svc.cluster.local:8001/mcp"
  NEXT_PUBLIC_API_URL: "https://todo-app.local/api"
  NEXT_PUBLIC_BETTER_AUTH_URL: "https://todo-app.local"
  NEXT_PUBLIC_CHATKIT_DOMAIN_KEY: ""  # Empty for local development
  CORS_ORIGINS: '["https://todo-app.local", "http://todo-app.local", "http://localhost:3000", "http://127.0.0.1:3000"]'
  KAFKA_SECURITY_PROTOCOL: "SASL_SSL"
  KAFKA_SASL_MECHANISM: "SCRAM-SHA-256"
  # Kafka Producer Configuration
  KAFKA_PRODUCER_INIT_TIMEOUT: "90"
  KAFKA_PRODUCER_MAX_RETRIES: "3"
  KAFKA_PRODUCER_RETRY_DELAY: "5"

# Helm Test Configuration
tests:
  enabled: true
  image:
    repository: "busybox"
    tag: "latest"
